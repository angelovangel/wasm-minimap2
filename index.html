<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Align reads to reference</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://omnipotent.net/jquery.sparkline/2.1.2/jquery.sparkline.min.js"></script>
    
    <style>
        /* Global & Typography */
        body { 
            padding-top: 30px; 
            padding-bottom: 30px; 
            font-family: 'Inter', sans-serif; 
            background-color: #f8f9fa;
        }
        h1 {
            color: #343a40;
            font-weight: 300;
        }
        .file-input { 
            margin-bottom: 15px; 
        } 
        
        /* Form Control - Making it flat */
        .form-control {
            border-radius: 0;
            box-shadow: none;
            border-color: #ced4da;
        }

        /* Button - Making it flat */
        .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
            border-radius: 0;
            box-shadow: none;
            text-transform: uppercase;
            font-weight: 500;
            letter-spacing: 0.5px;
        }
        .btn-primary:hover, .btn-primary:focus {
            background-color: #0056b3;
            border-color: #0056b3;
            box-shadow: none;
        }
        
        /* NEW: Download Button Style */
        .btn-success {
            background-color: #28a745;
            border-color: #28a745;
            border-radius: 0;
            box-shadow: none;
            text-transform: uppercase;
            font-weight: 500;
            letter-spacing: 0.5px;
        }
        .btn-success:hover, .btn-success:focus {
            background-color: #1e7e34;
            border-color: #1e7e34;
            box-shadow: none;
        }
        
        /* Container for Run and Download buttons */
        .action-buttons {
            display: flex;
            align-items: center;
            margin-top: 30px;
            margin-bottom: 30px; /* Adjusted margin to control spacing */
        }

        /* List View Styles - Flat and clean */
        .depth-list {
            list-style: none;
            padding: 0;
            overflow: visible;
            border-top: 1px solid #e9ecef;
        }

        .depth-item {
            display: flex;
            align-items: center;
            /*font-size: 13px;*/
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            margin-bottom: 0;
            background-color: #fff;
            transition: background-color 0.2s;
        }
        
        .depth-item:hover {
            background-color: #f1f1f1;
        }

        /* Remove all individual corner radii for a flat look */
        .depth-item:first-child,
        .depth-item:last-child {
            border-radius: 0;
        }

        .contig-name { flex: 1; text-align: left; padding-left: 30px; font-weight: 500; color: #495057;  }
        .mean-depth { flex: 0.8; text-align: right; font-weight: 500; color: #495057; }
        .contig-length { flex: 0.5; text-align: right; font-weight: 500; color: #495057; }
        .coverage { flex: 0.5; text-align: right; font-weight: 500; color: #495057; }
        .mean-mapq { flex: 0.5; text-align: right; padding-right: 15px; font-weight: 500; color: #495057; }
        .depth-profile { flex: 4; text-align: left; padding-left: 30px; font-weight: 500; color: #495057;  }

        /* Header Row - Simple and distinct */
        .depth-list-headers {
            background-color: #e9ecef;
            color: #6c757d !important;
            font-weight: 500;
            /*font-size: 13px;*/
            text-transform: uppercase;
            text-align: right;
            /*letter-spacing: 0.5px;*/
            padding: 10px 20px !important;
            border: none !important;
            margin-bottom: 0 !important;
        }

        /* Sparkline container */
        .sparkline-container {
            min-height: 50px;
            display: inline-block;
            vertical-align: bottom;
            width: 100%;
        }

        /* Alerts - Simple and flat */
        .alert {
            border-radius: 0;
            border: 1px solid transparent;
            font-weight: 500;
        }
        
        /* ðŸ’¡ NEW/MODIFIED STYLE FOR BIGGER TOOLTIP */
        .jqstooltip {
            /* Increase padding to make the box bigger */
            
            /* Increase font size for better readability */
            font-size: 16px !important; 
            width: 150px !important;
            height: 50px !important;
            /* Adjust background color and border for flat look (optional) */
            background-color: rgba(0, 0, 0, 0.75) !important;
            border: none !important;
            border-radius: 3px !important;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2) !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-5">minimap2 in the browser</h1>
        
        <div class="row">
            
            <div class="col-md-6 file-input">
                <label for="ref" class="form-label fw-bold">1. Reference (.fasta/.fa)</label>
                <input type="file" id="ref" class="form-control" accept=".fasta,.fa">
            </div>
            
            <div class="col-md-6 file-input">
                <label for="query" class="form-label fw-bold">2. Query Reads (.fastq/.fq)</label>
                <input type="file" id="query" class="form-control" multiple accept=".fastq,.gz">
            </div>
            
        </div>
        
        <div class="action-buttons">
            <button id="btn" class="btn btn-primary btn-lg me-3">
                <i class="fas fa-play"></i> RUN
            </button>
            <a id="download-bam" href="#" class="btn btn-success btn-lg" style="display: none;" download="output.sorted.bam">
                <i class="fas fa-download"></i> Download BAM
            </a>
        </div>
        
        <div id="output" class="mb-5">
            <p id="initial-message" class="text-muted">Upload your files and click 'Run Analysis', no data leaves the browser.</p>
        </div>
        
        <div class="depth-list-headers depth-item">
            <div class="contig-name">Contig</div>
            <div class="contig-length">Length</div>
            <div class="mean-depth">Mean Depth</div>
            
            <div class="coverage">Cov (%)</div>
            <div class="mean-mapq">MAPQ</div>
            <div class="depth-profile">Depth Profile</div>
        </div>

        <div>
            <ul id="depthList" class="depth-list">
                </ul>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script src="https://biowasm.com/cdn/v3/aioli.js"></script>
    
    <script type="module">
        const CLI = await new Aioli([
            "samtools/1.10", 
            "minimap2/2.22",
            // {
            //     tool: "faster2",
            //     version: "0.3.0",
            //     urlPrefix: "http://localhost:8000/faster2"
            // }
        ], {debug: true});

        const MAX_POINTS = 300; 
        
        const SPARKLINE_COLOR = '#4c9aff';
        
        // **NEW GLOBAL VARIABLE** to store max length for proportional scaling
        let maxContigLength = 1; // Initialize to 1 to avoid division by zero

        // Aggressive cleaning function to ensure keys match
        function cleanContigName(name) {
            // Trim whitespace
            return name.trim();
        }

        function subsampleDepthData(data) {
            if (data.length <= MAX_POINTS) {
                return data;
            }

            const step = Math.ceil(data.length / MAX_POINTS);
            const subsampled = [];
            
            for (let i = 0; i < data.length; i += step) {
                subsampled.push(data[i]);
            }
            
            if (subsampled.length === 0 && data.length > 0) {
                 subsampled.push(data[0]);
            }
            
            return subsampled;
        }

        // **MODIFIED RENDER FUNCTION** to use proportional width
        function renderSparklines() {
            $('#depthList .sparkline-container').each(function() {
                const $this = $(this);
                const depths = $this.data('depths'); 
                const contigLength = $this.data('length'); // Get length
                
                // Calculate proportional width (max 100%)
                const proportionalWidth = Math.max(20, (contigLength / maxContigLength) * 100); 
                
                // Apply proportional width to the container
                $this.css('width', `${proportionalWidth}%`);

                if (depths && depths.length > 0) {
                    $this.sparkline(depths, {
                        type: 'line',
                        width: '100%', // Sparkline fills its container's proportional width
                        height: '50px',
                        lineColor: SPARKLINE_COLOR, 
                        fillColor: SPARKLINE_COLOR + '33',
                        spotColor: false,
                        minSpotColor: false,
                        maxSpotColor: false, 
                        chartRangeMin: 0,
                        highlightLineColor: '#6c757d', 
                        highlightSpotColor: '#6c757d', 
                        tooltipFormat: 'Depth: {{y}}' 
                    });
                } else {
                    $this.text('No depth data');
                }
            });
        }

        async function run() {
            const outputDiv = document.getElementById("output");
            const ulList = document.getElementById('depthList');
            const downloadButton = document.getElementById("download-bam"); 
            const initialMessage = document.getElementById("initial-message"); 
            
            // 1. Initial State Setup
            // Display 'Running' message and hide the initial instruction
            outputDiv.innerHTML = '<div class="alert alert-info" role="alert">Running analysis... This may take a moment.</div>';
            document.getElementById("btn").disabled = true;
            //downloadButton.style.display = 'none'; // Hide button at start of run
            ulList.innerHTML = ''; 
            
            // Reset maxContigLength at the start of a run
            maxContigLength = 1;

            try {
                const q = document.getElementById("query").files;
                const r = document.getElementById("ref").files;

                if (q.length === 0 || r.length === 0) {
                    outputDiv.innerHTML = '<div class="alert alert-danger" role="alert">Please select both a **Reference Genome** and **Query Reads** file(s).</div>';
                    document.getElementById("btn").disabled = false;
                    return;
                }

                const query = await CLI.mount(q); 
                const ref = await CLI.mount(r);   

                // --- PIPELINE EXECUTION ---
                
                await CLI.exec("minimap2", [
                    "-a",
                    "-I", "1G",
                    "-K", "100M",
                    "-o", "output.sam",
                    "-x", "map-ont",
                    ref[0], 
                    ...query
                ]);
                await CLI.exec("samtools view -S -b output.sam -o output.bam");
                
                await CLI.exec("samtools sort -o output.sorted.bam output.bam");
                await CLI.exec("samtools index output.sorted.bam");

                // for downloading the BAM file
                const download_url = await CLI.download("output.sorted.bam");
                
                // **SUCCESS**: Set the download URL and show the button
                downloadButton.href = download_url;
                downloadButton.style.display = 'inline-block'; // Show the button
                
                // **MODIFIED**: Clear the status/output div completely after a successful BAM generation
                outputDiv.innerHTML = ''; 

                const depthOutput = await CLI.exec("samtools depth -aa output.sorted.bam");
                
                // Capture samtools coverage output with -H (header)
                const covOutput = await CLI.exec("samtools coverage -H output.sorted.bam");
                
                // --- DATA AGGREGATION & LIST POPULATION ---
                
                // Robust parsing for samtools depth output
                const contigData = {}; 
                const lines = depthOutput.trim().split('\n').filter(line => line.length > 0);
                
                if (lines.length === 0) {
                    outputDiv.innerHTML = '<div class="alert alert-warning" role="alert">Analysis completed, but no depth data was generated. Check your input files.</div>';
                    downloadButton.style.display = 'none';
                    document.getElementById("btn").disabled = false;
                    return;
                }

                lines.forEach(line => {
                    const fields = line.split('\t');
                    if (fields.length === 3) {
                        const [rname, pos, depthStr] = fields;
                        
                        // Use clean function
                        const cleanRname = cleanContigName(rname); 
                        const depth = parseInt(depthStr.trim(), 10);
                        
                        if (!contigData[cleanRname]) {
                            // **MODIFIED**: Added 'length' property
                            contigData[cleanRname] = { depths: [], sum: 0, count: 0, length: 0 };
                        }
                        
                        contigData[cleanRname].depths.push(depth);
                        contigData[cleanRname].sum += depth;
                        contigData[cleanRname].count++;
                        contigData[cleanRname].length++; // Increment length (number of depth points)
                    }
                });
                
                // **NEW STEP**: Find the maximum contig length for scaling
                for (const rname in contigData) {
                    maxContigLength = Math.max(maxContigLength, contigData[rname].length);
                }

                // CORRECTED: Parse samtools coverage output for 9 fields
                const covLines = covOutput.trim().split('\n').filter(line => line.length > 0);
                console.log("Coverage output lines:", covLines);
                const contigCoverageStats = {};

                if (covLines.length >= 1) {
                    for (let i = 0; i < covLines.length; i++) {
                        // Use split by any whitespace and filter out empty strings
                        //const fields = covLines[i].split(/\s+/).filter(f => f.length > 0);
                        const fields = covLines[i].split('\t');
                        // Check for the expected 9 fields
                        if (fields.length >= 8) {
                            try {
                                const rname = fields[0];
                                const cleanCovRname = cleanContigName(rname);
                                console.log("Processing coverage for contig:", cleanCovRname);
                                
                                // Skip the overall summary line ('*')
                                //if (cleanCovRname && cleanCovRname !== '*') {
                                    // 9-Field Output Indices:
                                    // 0:#rname, 1:startpos, 2:endpos, 3:numreads, 4:coveredbases, 5:coverage, 6:meandepth, 7:meanbaseq, 8:meanmapq
                                    const numreads = parseInt(fields[3], 10); 
                                    const contLength = parseInt(fields[2], 10);
                                    const avgmapq = parseFloat(fields[8]).toFixed(0); 
                                    const coverage = parseFloat(fields[5]).toFixed(1);
                                    console.log(`Contig: ${cleanCovRname}, Length: ${contLength}, Reads: ${numreads}, Coverage: ${coverage}, Mean MAPQ: ${avgmapq}`);
                                    
                                    contigCoverageStats[cleanCovRname] = {
                                        contLength: isNaN(contLength) ? 0 : contLength,
                                        numreads: isNaN(numreads) ? 0 : numreads,
                                        coverage: isNaN(parseFloat(coverage)) ? '0.0' : coverage,
                                        meanmapq: isNaN(parseFloat(avgmapq)) ? '0' : avgmapq
                                    };
                                //}
                            } catch (e) {
                                console.error("Error parsing coverage line:", covLines[i], e);
                            }
                        } else {
                            console.warn("Skipping coverage line due to missing fields (expected 9+, got " + fields.length + "):", covLines[i]);
                        }
                    }
                }
                
                const listItemsHtml = [];
                // Iterate over the successfully parsed depth data (using the cleaned keys)
                for (const rname in contigData) {
                    const data = contigData[rname];
                    const meanDepth = data.count > 0 ? (data.sum / data.count).toFixed(0) : '0';
                    
                    const subsampledDepths = subsampleDepthData(data.depths);
                    const depthsJSON = JSON.stringify(subsampledDepths);
                    
                    // **MODIFIED**: Pass the contig length using a data attribute
                    const sparklineHtml = `<span class="sparkline-container" data-depths='${depthsJSON}' data-length='${data.length}'></span>`;

                    // Lookup coverage stats using the same cleaned key
                    const stats = contigCoverageStats[rname] || { numreads: 0, contLength: 0, coverage: '0.0', meanmapq: '0' };
                    
                    // Format output
                    const numreads = stats.numreads.toLocaleString(); 
                    const contLength = stats.contLength.toLocaleString();
                    const coverage = stats.coverage + '%';
                    const meanmapq = stats.meanmapq;

                    // Insert new columns into the list item HTML
                    const listItem = `
                        <li class="depth-item">
                            <div class="contig-name">${rname}</div>
                            <div class="contig-length">${contLength}</div>
                            <div class="mean-depth">${meanDepth}</div>
                            
                            <div class="coverage">${coverage}</div>
                            <div class="mean-mapq">${meanmapq}</div>
                            <div class="depth-profile">${sparklineHtml}</div>
                        </li>
                    `;
                    listItemsHtml.push(listItem);
                }
                
                ulList.innerHTML = listItemsHtml.join('');

                // --- SPARKLINE RENDERING ---
                renderSparklines(); 

            } catch (error) {
                console.error(error);
                // On error, display error message and hide the download button
                downloadButton.style.display = 'none';
                outputDiv.innerHTML = `<div class="alert alert-danger" role="alert">An error occurred during execution: **${error.message || String(error) || 'Unknown Aioli/CLI Error'}**</div>`;
            } finally {
                document.getElementById("btn").disabled = false;
            }
        }
        
        document.getElementById("btn").addEventListener("click", run);
    </script>
</body>
</html>